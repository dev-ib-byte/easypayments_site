#!/bin/bash

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ .env —Ñ–∞–π–ª–∞
set -o allexport
source .env
set +o allexport


echo "üîç –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
echo "DB__HOST=$DB__HOST"
echo "DB__PORT=$DB__PORT"
echo "DB__NAME=$DB__NAME"
echo "DB__USER=$DB__USER"
echo "DB__PASSWORD=$DB__PASSWORD"
echo "DEFAULT_ADMIN_USER=$DEFAULT_ADMIN_USER"
echo "DEFAULT_ADMIN_PASSWORD=$DEFAULT_ADMIN_PASSWORD"
echo "SQLALCHEMY_DATABASE_URI=$SQLALCHEMY_DATABASE_URI"
echo "ALEMBIC_CONFIG=$ALEMBIC_CONFIG"
echo "-----------------------------"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ postgresql-client, –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if ! command -v psql &> /dev/null; then
    echo "‚ùó postgresql-client –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
    apk update
    apk add --no-cache postgresql16-client
fi

#
## üîê –ñ—ë—Å—Ç–∫–æ –∑–∞–¥–∞–Ω–Ω—ã–π —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è root)
DEFAULT_ADMIN_USER=$DEFAULT_ADMIN_USER
DEFAULT_ADMIN_PASSWORD=$DEFAULT_ADMIN_PASSWORD

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_exists() {
    local user=$1
    export PGPASSWORD="$DEFAULT_ADMIN_PASSWORD"
    psql -h "$DB__HOST" -p "$DB__PORT" -U "$DEFAULT_ADMIN_USER" -d postgres \
        -tc "SELECT 1 FROM pg_roles WHERE rolname='$user'" | grep -q 1
    return $?
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
database_exists() {
    local db=$1
    export PGPASSWORD="$DEFAULT_ADMIN_PASSWORD"
    psql -h "$DB__HOST" -p "$DB__PORT" -U "$DEFAULT_ADMIN_USER" -d postgres \
        -tc "SELECT 1 FROM pg_database WHERE datname = '$db'" | grep -q 1
    return $?
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
migrations_applied() {
    local config=$1
    alembic -c "$config" current | grep -q "head"
    return $?
}

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
if ! user_exists "$DB__USER"; then
    echo "–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $DB__USER..."
    export PGPASSWORD="$DEFAULT_ADMIN_PASSWORD"
    psql -h "$DB__HOST" -p "$DB__PORT" -U "$DEFAULT_ADMIN_USER" -d postgres \
        -c "CREATE USER $DB__USER WITH PASSWORD '$DB__PASSWORD';"
else
    echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å $DB__USER —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ."
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å –¥–ª—è psql
export PGPASSWORD="$DB__PASSWORD"

# –ü—É—Ç—å –¥–æ Alembic –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
ALEMBIC_CONFIG="alembic.ini"

# –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
if ! database_exists "$DB__NAME"; then
    echo "–°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö $DB__NAME —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º $DB__USER..."
    export PGPASSWORD="$DEFAULT_ADMIN_PASSWORD"
    psql -h "$DB__HOST" -p "$DB__PORT" -U "$DEFAULT_ADMIN_USER" -d postgres \
        -c "CREATE DATABASE $DB__NAME OWNER $DB__USER;"

    # –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö - —Å–º–µ–Ω–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞
    psql -h "$DB__HOST" -p "$DB__PORT" -U "$DEFAULT_ADMIN_USER" -d "$DB__NAME" \
        -c "ALTER DATABASE $DB__NAME OWNER TO $DB__USER;"
else
    echo "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö $DB__NAME —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞..."
    export PGPASSWORD="$DEFAULT_ADMIN_PASSWORD"
    psql -h "$DB__HOST" -p "$DB__PORT" -U "$DEFAULT_ADMIN_USER" -d "$DB__NAME" \
        -c "ALTER DATABASE $DB__NAME OWNER TO $DB__USER;"
fi

ALEMBIC_LOG_FILE="alembic_autogenerate.log"

echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –º–æ–¥–µ–ª—è—Ö –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏..."
echo "=== –í—ã–≤–æ–¥ alembic revision --autogenerate ===" > "$ALEMBIC_LOG_FILE"

# –ó–∞–ø—É—Å–∫–∞–µ–º alembic, –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –í–ï–°–¨ –≤—ã–≤–æ–¥ –≤ –ª–æ–≥ –∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ
NEW_REV_FILE=$(alembic -c "$ALEMBIC_CONFIG" revision --autogenerate -m "Auto migration" 2>&1 | tee -a "$ALEMBIC_LOG_FILE" | grep "Generating" | awk '{print $2}')

echo "=== –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ ===" >> "$ALEMBIC_LOG_FILE"
echo "NEW_REV_FILE=$NEW_REV_FILE" >> "$ALEMBIC_LOG_FILE"

if [ -n "$NEW_REV_FILE" ] && [ -f "$NEW_REV_FILE" ]; then
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
    if grep -q "pass" "$NEW_REV_FILE" && \
       grep -q "# ### commands auto generated by Alembic" "$NEW_REV_FILE" && \
       [ $(grep -c "op.create_table\|op.drop_table\|op.add_column\|op.drop_column" "$NEW_REV_FILE") -eq 0 ]; then
        echo "‚ùï –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç, —É–¥–∞–ª—è–µ–º –ø—É—Å—Ç—É—é –º–∏–≥—Ä–∞—Ü–∏—é: $NEW_REV_FILE"
        rm "$NEW_REV_FILE"
    else
        echo "üöÄ –ù–∞–π–¥–µ–Ω–∞ –Ω–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è: $NEW_REV_FILE, –ø—Ä–∏–º–µ–Ω—è–µ–º..."
        alembic -c "$ALEMBIC_CONFIG" upgrade head
    fi
else
    echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã, –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."
fi

echo "‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞."